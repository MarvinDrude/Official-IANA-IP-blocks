name: Dependabot auto-approve and merge

on:
  pull_request_target:

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-slim
    if: github.actor == 'dependabot[bot]' && github.repository == 'HotCakeX/Official-IANA-IP-blocks'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Approve and Merge
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr checkout "$PR_URL"

          # Approve
          REVIEW_DECISION=$(gh pr view "$PR_URL" --json reviewDecision -q .reviewDecision)
          if [ "$REVIEW_DECISION" != "APPROVED" ]; then
            gh pr review --approve "$PR_URL"
            echo "PR approved."
          else
            echo "PR already approved."
          fi

          echo "Waiting for checks..."
          while true; do
            # statusCheckRollup is an array of check run objects.
            # Each object has a "status" field (COMPLETED, IN_PROGRESS, QUEUED, etc.)
            # and completed ones have a "conclusion" field (SUCCESS, FAILURE, etc.).
            # We need to check all of them to determine overall state.

            CHECKS_JSON=$(gh pr view "$PR_URL" --json statusCheckRollup -q '.statusCheckRollup')

            # If the array is empty or null, checks haven't been registered yet
            if [ -z "$CHECKS_JSON" ] || [ "$CHECKS_JSON" == "null" ] || [ "$CHECKS_JSON" == "[]" ]; then
              echo "No checks found yet. Waiting..."
              sleep 10
              continue
            fi

            # Count total checks
            TOTAL=$(echo "$CHECKS_JSON" | jq 'length')

            # Count how many checks have completed
            # CheckRun objects use "status" (COMPLETED) and "conclusion" (SUCCESS, FAILURE, etc.)
            # StatusContext objects use "state" (SUCCESS, FAILURE, PENDING, etc.)
            COMPLETED=$(echo "$CHECKS_JSON" | jq '[.[] | select(
              (.status == "COMPLETED") or
              (.state == "SUCCESS") or
              (.state == "FAILURE") or
              (.state == "ERROR")
            )] | length')

            echo ""
            echo "===== Check Status Report ($COMPLETED/$TOTAL completed) ====="

            # Log each check's name, status, and conclusion (safe fields only, no URLs or secrets)
            echo "$CHECKS_JSON" | jq -r '.[] |
              if .status then
                # CheckRun object
                "  [CheckRun]     name=\"\(.name)\"  status=\(.status)  conclusion=\(.conclusion // "N/A")"
              else
                # StatusContext object
                "  [StatusContext] context=\"\(.context)\"  state=\(.state)"
              end'

            echo "==============================================="

            if [ "$COMPLETED" -eq "$TOTAL" ]; then
              # All checks completed, now check if any failed
              FAILED=$(echo "$CHECKS_JSON" | jq '[.[] | select(
                (.conclusion == "FAILURE") or
                (.conclusion == "CANCELLED") or
                (.conclusion == "TIMED_OUT") or
                (.state == "FAILURE") or
                (.state == "ERROR")
              )] | length')

              if [ "$FAILED" -gt 0 ]; then
                echo "Some checks failed or errored ($FAILED failure(s))."
                exit 1
              fi

              echo "All $TOTAL checks passed!"
              break
            fi

            sleep 10
          done

          # Merge
          gh pr merge --merge --delete-branch "$PR_URL"
